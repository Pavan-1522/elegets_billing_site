<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fund Management - Elegets Electronics</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* 1. THEME VARIABLES */
    :root {
      --primary: #4361ee; --primary-dark: #3a56d4; --secondary: #3f37c9;
      --dark: #0c0e1c; --dark-light: #1a1d2e; --light: #f8f9fa;
      --success: #4cc9f0; --warning: #f8961e; --danger: #f72585;
      --credit: #4ade80; --debit: #f87171;
      --status-completed: #4ade80; --status-pending: #f8961e; --status-failed: #f87171;
    }
    
    body { background-color: var(--dark); color: var(--light); font-family: 'Inter', sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
    
    /* 2. UI COMPONENTS */
    .navbar { background-color: var(--dark-light); box-shadow: 0 2px 15px rgba(0,0,0,0.1); border-bottom: 1px solid rgba(255,255,255,0.05); }
    .navbar-brand { font-weight: 700; color: var(--light); display: flex; align-items: center; }
    .navbar-brand i { color: var(--primary); margin-right: 10px; }
    .nav-link { color: rgba(255,255,255,0.8); font-weight: 500; transition: all 0.3s ease; }
    .nav-link:hover, .nav-link.active { color: var(--light); }
    .nav-link.active { color: var(--primary); }
    
    .card { background-color: var(--dark-light); border: none; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; margin-bottom: 2rem; }
    .card-header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 1.5rem; border-bottom: none; }
    .card-body { padding: 2rem; }
    
    /* 3. INPUTS & FORMS */
    .form-label { color: rgba(255,255,255,0.9); font-weight: 500; margin-bottom: 0.5rem; }
    .form-control, .form-select { 
        background-color: rgba(255,255,255,0.05); 
        border: 1px solid rgba(255,255,255,0.1); 
        color: var(--light); /* Text color inside inputs */
        border-radius: 8px; 
        transition: all 0.3s ease; 
    }
    .form-control:focus, .form-select:focus { 
        background-color: rgba(255,255,255,0.08); 
        border-color: var(--primary); 
        box-shadow: 0 0 0 0.25rem rgba(67,97,238,0.25); 
        color: var(--light); 
    }
    
    /* Fix for dropdown options visibility */
    .form-select option {
        background-color: var(--dark-light);
        color: var(--light);
    }

    .btn:disabled { cursor: not-allowed; opacity: 0.65; }
    
    #message { margin-top: 1.5rem; padding: 1rem; border-radius: 8px; font-weight: 500; display: none; }
    .success-message { background-color: rgba(76,201,240,0.1); border-left: 4px solid var(--success); color: var(--success); }
    .error-message { background-color: rgba(247,37,133,0.1); border-left: 4px solid var(--danger); color: var(--danger); }
    
    .page-title { margin: 2rem 0; position: relative; padding-bottom: 1rem; }
    .page-title:after { content: ''; position: absolute; bottom: 0; left: 0; width: 60px; height: 4px; background: linear-gradient(90deg, var(--primary), var(--secondary)); border-radius: 2px; }
    
    /* 4. SUMMARY CARDS */
    .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .summary-card { background-color: var(--dark-light); border-radius: 12px; padding: 1.5rem; box-shadow: 0 5px 20px rgba(0,0,0,0.15); transition: transform 0.3s ease; }
    .summary-card:hover { transform: translateY(-5px); }
    .summary-card.balance { border-left: 4px solid var(--primary); }
    .summary-card.credits { border-left: 4px solid var(--credit); }
    .summary-card.debits { border-left: 4px solid var(--debit); }
    .summary-card h3 { font-size: 1rem; color: rgba(255,255,255,0.7); margin-bottom: 0.5rem; }
    .summary-card .amount { font-size: 1.75rem; font-weight: 700; }
    .balance .amount { color: var(--primary); }
    .credits .amount { color: var(--credit); }
    .debits .amount { color: var(--debit); }
    
    .nav-pills .nav-link { color: rgba(255,255,255,0.7); background-color: rgba(255,255,255,0.05); margin-right: 0.5rem; border-radius: 8px; }
    .nav-pills .nav-link.active { background-color: var(--primary); color: white; }
    
    /* 5. TABLES */
    .transaction-table { width: 100%; min-width: 800px; border-collapse: separate; border-spacing: 0; }
    .transaction-table thead th { background-color: rgba(255,255,255,0.05); color: rgba(255,255,255,0.8); padding: 1rem; text-align: left; font-weight: 600; }
    .transaction-table tbody tr:hover { background-color: rgba(255,255,255,0.03); }
    .transaction-table tbody td { 
        padding: 1rem; 
        border-bottom: 1px solid rgba(255,255,255,0.05); 
        vertical-align: middle; 
        color: var(--light); /* Ensure table text is white */
    }
    
    .transaction-table .badge { padding: 0.5em 0.75em; border-radius: 8px; font-weight: 600; text-transform: capitalize; font-size: 0.75rem; }
    .badge-credit { background-color: rgba(74,222,128,0.1); color: var(--credit); }
    .badge-debit { background-color: rgba(248,113,113,0.1); color: var(--debit); }
    .badge-status-completed { background-color: rgba(74,222,128,0.1); color: var(--status-completed); }
    .badge-status-pending { background-color: rgba(248,150,30,0.1); color: var(--status-pending); }
    .badge-status-failed { background-color: rgba(248,113,113,0.1); color: var(--status-failed); }
    .amount-cell.credit { color: var(--credit) !important; }
    .amount-cell.debit { color: var(--debit) !important; }
    .no-transactions { text-align: center; padding: 2rem; color: rgba(255,255,255,0.5); }
    
    @media (max-width: 992px) {
      .transaction-table thead { display: none; }
      .transaction-table, .transaction-table tbody, .transaction-table tr, .transaction-table td { display: block; width: 100% !important; min-width: 0; }
      .transaction-table tbody tr { margin-bottom: 1rem; border-radius: 8px; background-color: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); }
      .transaction-table tbody td { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
      .transaction-table tbody tr td:last-child { border-bottom: none; }
      .transaction-table tbody td::before { content: attr(data-label); font-weight: 600; margin-right: 1rem; color: rgba(255,255,255,0.6); }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid"><a class="navbar-brand" href="#"><i class="fas fa-microchip"></i><span>Elegets Electronics</span></a><button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNav"><ul class="navbar-nav mx-auto"><li class="nav-item"><a class="nav-link" href="dashboard.html"><i class="fas fa-home me-2"></i> Dashboard</a></li><li class="nav-item"><a class="nav-link active" href="#"><i class="fas fa-wallet me-2"></i> Funds</a></li></ul><div class="d-flex"><div class="dropdown"><button class="btn btn-outline-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown"><i class="fas fa-user-circle me-2"></i><span id="usernameDisplay">User</span></button><ul class="dropdown-menu dropdown-menu-end"><li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i> Logout</a></li></ul></div></div></div></div>
  </nav>

  <main class="container my-4 flex-grow-1">
    <h1 class="page-title">Fund Management</h1>
    <div class="summary-cards">
      <div class="summary-card balance"><h3>Available Balance</h3><div class="amount" id="availableBalance">₹0.00</div></div>
      <div class="summary-card credits"><h3>Total Credits</h3><div class="amount" id="totalCredits">₹0.00</div></div>
      <div class="summary-card debits"><h3>Total Debits</h3><div class="amount" id="totalDebits">₹0.00</div></div>
    </div>
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="mb-0"><i class="fas fa-exchange-alt me-2"></i> Transaction Records</h3>
        <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addTransactionModal"><i class="fas fa-plus me-2"></i> Add Transaction</button>
      </div>
      <div class="card-body">
        <ul class="nav nav-pills mb-4" id="transactionTabs" role="tablist">
          <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#all" type="button">All Transactions</button></li>
          <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#credits" type="button">Credits</button></li>
          <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#debits" type="button">Debits</button></li>
        </ul>
        <div class="row g-3 mb-4">
          <div class="col-lg-4 col-md-12"><input type="text" id="searchInput" class="form-control" placeholder="Search description, UTR, Bill No..."></div>
          <div class="col-lg-2 col-md-6"><select id="categoryFilter" class="form-select"><option value="">All Categories</option><option value="customer_payment">Customer Payment</option><option value="supplier_payment">Supplier Payment</option><option value="expense">Expense</option><option value="investment">Investment</option><option value="other">Other</option></select></div>
          <div class="col-lg-2 col-md-6"><select id="modeFilter" class="form-select"><option value="">All Modes</option><option value="upi">UPI</option><option value="card">Card</option><option value="bank_transfer">Bank Transfer</option><option value="cash">Cash</option></select></div>
          <div class="col-lg-2 col-md-6"><select id="statusFilter" class="form-select"><option value="">All Statuses</option><option value="completed">Completed</option><option value="pending">Pending</option><option value="failed">Failed</option></select></div>
          <div class="col-lg-2 col-md-6"><input type="date" id="dateFilter" class="form-control"></div>
        </div>
        <div class="tab-content">
          <div class="tab-pane fade show active" id="all" role="tabpanel"><div class="table-responsive"><table class="transaction-table"><thead><tr><th>Date</th><th>Type</th><th>Description</th><th>Mode</th><th>Status</th><th>Amount</th><th>Actions</th></tr></thead><tbody id="allTransactionsTable"></tbody></table><div id="allNoTransactions" class="no-transactions"></div></div></div>
          <div class="tab-pane fade" id="credits" role="tabpanel"><div class="table-responsive"><table class="transaction-table"><thead><tr><th>Date</th><th>Description</th><th>Mode</th><th>Status</th><th>Amount</th><th>Actions</th></tr></thead><tbody id="creditsTable"></tbody></table><div id="creditsNoTransactions" class="no-transactions"></div></div></div>
          <div class="tab-pane fade" id="debits" role="tabpanel"><div class="table-responsive"><table class="transaction-table"><thead><tr><th>Date</th><th>Description</th><th>Mode</th><th>Status</th><th>Amount</th><th>Actions</th></tr></thead><tbody id="debitsTable"></tbody></table><div id="debitsNoTransactions" class="no-transactions"></div></div></div>
        </div>
      </div>
    </div>
    <div id="message"></div>
  </main>

  <div class="modal fade" id="addTransactionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header"><h5 class="modal-title">Add New Transaction</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="transactionForm">
            <div class="row">
              <div class="col-md-6 mb-3"><label class="form-label">Transaction Type</label><select class="form-select" id="transactionType" required><option value="">Select type</option><option value="credit">Credit (Income)</option><option value="debit">Debit (Expense)</option></select></div>
              <div class="col-md-6 mb-3"><label class="form-label">Transaction Date</label><input type="date" class="form-control" id="transactionDate" required></div>
              <div class="col-md-12 mb-3"><label class="form-label">Description</label><input type="text" class="form-control" id="transactionDescription" placeholder="e.g., Payment from Client X" required></div>
              <div class="col-md-6 mb-3"><label class="form-label">Amount</label><div class="input-group"><span class="input-group-text">₹</span><input type="number" class="form-control" id="transactionAmount" placeholder="0.00" step="0.01" min="0" required></div></div>
              <div class="col-md-6 mb-3"><label class="form-label">Category</label><select class="form-select" id="transactionCategory" required><option value="">Select category</option><option value="customer_payment">Customer Payment</option><option value="supplier_payment">Supplier Payment</option><option value="expense">Business Expense</option><option value="investment">Investment</option><option value="other">Other</option></select></div>
              <div class="col-md-6 mb-3"><label class="form-label">Mode of Payment</label><select class="form-select" id="transactionMode" required><option value="">Select mode</option><option value="upi">UPI</option><option value="card">Card</option><option value="bank_transfer">Bank Transfer</option><option value="cash">Cash</option></select></div>
              <div class="col-md-6 mb-3"><label class="form-label">Status</label><select class="form-select" id="transactionStatus" required><option value="completed">Completed</option><option value="pending">Pending</option><option value="failed">Failed</option></select></div>
              <div class="col-md-6 mb-3"><label class="form-label">UTR Number (Optional)</label><input type="text" class="form-control" id="transactionUtr" placeholder="For UPI/Bank Transfer"></div>
              <div class="col-md-6 mb-3"><label class="form-label">Bill No (Optional)</label><input type="text" class="form-control" id="transactionBillNo" placeholder="Associated Bill Number"></div>
            </div>
            <div id="transactionMessage" class="mt-3"></div>
          </form>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" id="saveTransactionBtn">Save Transaction</button></div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editTransactionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header"><h5 class="modal-title">Edit Transaction</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="editTransactionForm">
            <input type="hidden" id="editTransactionId">
             <div class="row">
              <div class="col-md-6 mb-3"><label class="form-label">Transaction Type</label><select class="form-select" id="editTransactionType" required><option value="credit">Credit (Income)</option><option value="debit">Debit (Expense)</option></select></div>
              <div class="col-md-6 mb-3"><label class="form-label">Transaction Date</label><input type="date" class="form-control" id="editTransactionDate" required></div>
              <div class="col-md-12 mb-3"><label class="form-label">Description</label><input type="text" class="form-control" id="editTransactionDescription" required></div>
              <div class="col-md-6 mb-3"><label class="form-label">Amount</label><div class="input-group"><span class="input-group-text">₹</span><input type="number" class="form-control" id="editTransactionAmount" placeholder="0.00" step="0.01" min="0" required></div></div>
              <div class="col-md-6 mb-3"><label class="form-label">Category</label><select class="form-select" id="editTransactionCategory" required><option value="customer_payment">Customer Payment</option><option value="supplier_payment">Supplier Payment</option><option value="expense">Business Expense</option><option value="investment">Investment</option><option value="other">Other</option></select></div>
              <div class="col-md-6 mb-3"><label class="form-label">Mode of Payment</label><select class="form-select" id="editTransactionMode" required><option value="upi">UPI</option><option value="card">Card</option><option value="bank_transfer">Bank Transfer</option><option value="cash">Cash</option></select></div>
              <div class="col-md-6 mb-3"><label class="form-label">Status</label><select class="form-select" id="editTransactionStatus" required><option value="completed">Completed</option><option value="pending">Pending</option><option value="failed">Failed</option></select></div>
              <div class="col-md-6 mb-3"><label class="form-label">UTR Number (Optional)</label><input type="text" class="form-control" id="editTransactionUtr"></div>
              <div class="col-md-6 mb-3"><label class="form-label">Bill No (Optional)</label><input type="text" class="form-control" id="editTransactionBillNo"></div>
            </div>
            <div id="editTransactionMessage" class="mt-3"></div>
          </form>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-danger me-auto" id="deleteTransactionBtn">Delete</button><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" id="updateTransactionBtn">Update Transaction</button></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <script>
    // --- CONFIGURATION ---
    const firebaseConfig = { apiKey: "AIzaSyASjV5eTtSWFih3pP8aJKzztj7PsxEW3Sg", authDomain: "elegets-bill-desk.firebaseapp.com", projectId: "elegets-bill-desk", storageBucket: "elegets-bill-desk.appspot.com", messagingSenderId: "716287582493", appId: "1:716287582493:web:28e4e23ef312aefb77c1f4" };
    const supabaseUrl = 'https://oborglvlgafnglzqczot.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ib3JnbHZsZ2FmbmdsenFjem90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MjE2MzEsImV4cCI6MjA2ODQ5NzYzMX0.dDt-_pcuEcyuvBlNvpMCspPXW04AU-KeFjIpQcWXXXk';

    // --- INITIALIZATION ---
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    
    // FIX: Renamed variable to 'supabaseClient' to avoid conflict with imported 'supabase' library
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

    // --- GLOBAL STATE ---
    let allTransactions = []; 

    // --- DOM ELEMENTS ---
    // Initialize elements ONLY after DOMContentLoaded to ensure they exist
    let elements = {};

    // --- UTILITY FUNCTIONS ---
    const formatCurrency = (amount) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount);
    const formatDate = (dateString) => new Date(dateString).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
    const formatCategory = (category) => (category || '').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    
    function showMessage(type, text, targetElement = elements.message) {
      targetElement.textContent = text;
      targetElement.className = `${type}-message`;
      targetElement.style.display = 'block';
      setTimeout(() => { targetElement.style.display = 'none'; }, 5000);
    }
    
    function toggleButtonState(button, isLoading, originalText) {
        button.disabled = isLoading;
        button.innerHTML = isLoading ? `<i class="fas fa-spinner fa-spin"></i> Processing...` : originalText;
    }

    // --- RENDERING FUNCTIONS ---
    function renderSummary(transactions) {
      const completed = transactions.filter(t => t.status === 'completed');
      const totalCredits = completed.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);
      const totalDebits = completed.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
      elements.availableBalance.textContent = formatCurrency(totalCredits - totalDebits);
      elements.totalCredits.textContent = formatCurrency(totalCredits);
      elements.totalDebits.textContent = formatCurrency(totalDebits);
    }

    function createTransactionRow(transaction, includeType = false) {
      const row = document.createElement('tr');
      row.dataset.id = transaction.id;
      const typeBadge = `<span class="badge ${transaction.type === 'credit' ? 'badge-credit' : 'badge-debit'}">${transaction.type}</span>`;
      const statusBadge = `<span class="badge badge-status-${transaction.status}">${transaction.status}</span>`;
      
      row.innerHTML = `
        <td data-label="Date">${formatDate(transaction.transaction_date)}</td>
        ${includeType ? `<td data-label="Type">${typeBadge}</td>` : ''}
        <td data-label="Description">${transaction.description}</td>
        <td data-label="Mode">${formatCategory(transaction.mode_of_payment)}</td>
        <td data-label="Status">${statusBadge}</td>
        <td data-label="Amount" class="amount-cell ${transaction.type}">${formatCurrency(transaction.amount)}</td>
        <td data-label="Actions"><button class="btn btn-sm btn-outline-primary edit-btn"><i class="fas fa-edit"></i></button></td>
        <td data-label="Category" style="display:none;">${formatCategory(transaction.category)}</td>
        <td data-label="UTR" style="display:none;">${transaction.utr_number || '-'}</td>
        <td data-label="Bill No." style="display:none;">${transaction.bill_no || '-'}</td>
      `;
      row.querySelector('.edit-btn').addEventListener('click', () => openEditModal(transaction.id));
      return row;
    }

    function renderTables(transactions) {
      const tables = [elements.allTransactionsTable, elements.creditsTable, elements.debitsTable];
      tables.forEach(t => t.innerHTML = '');

      const creditTransactions = transactions.filter(t => t.type === 'credit');
      const debitTransactions = transactions.filter(t => t.type === 'debit');

      transactions.forEach(t => elements.allTransactionsTable.appendChild(createTransactionRow(t, true)));
      creditTransactions.forEach(t => elements.creditsTable.appendChild(createTransactionRow(t, false)));
      debitTransactions.forEach(t => elements.debitsTable.appendChild(createTransactionRow(t, false)));

      elements.allNoTransactions.style.display = transactions.length === 0 ? 'block' : 'none';
      elements.creditsNoTransactions.style.display = creditTransactions.length === 0 ? 'block' : 'none';
      elements.debitsNoTransactions.style.display = debitTransactions.length === 0 ? 'block' : 'none';
    }

    function renderUI(transactionsToDisplay) {
        renderSummary(transactionsToDisplay);
        renderTables(transactionsToDisplay);
    }

    // --- DATA & EVENT HANDLING ---
    async function loadAndRenderData() {
        try {
            // FIX: Using supabaseClient
            const { data, error } = await supabaseClient.from('transactions').select('*').order('transaction_date', { ascending: false });
            if (error) throw error;
            allTransactions = data;
            renderUI(allTransactions);
        } catch (error) {
            console.error(error);
            showMessage('error', 'Failed to load transaction data.');
        }
    }
    
    async function handleSaveTransaction() {
      const newTransaction = {
        type: document.getElementById('transactionType').value,
        transaction_date: document.getElementById('transactionDate').value,
        description: document.getElementById('transactionDescription').value,
        amount: parseFloat(document.getElementById('transactionAmount').value),
        category: document.getElementById('transactionCategory').value,
        mode_of_payment: document.getElementById('transactionMode').value,
        status: document.getElementById('transactionStatus').value,
        utr_number: document.getElementById('transactionUtr').value,
        bill_no: document.getElementById('transactionBillNo').value,
      };

      if (!newTransaction.type || !newTransaction.transaction_date || !newTransaction.amount || !newTransaction.description || !newTransaction.category || !newTransaction.mode_of_payment) {
        return showMessage('error', 'Please fill all required fields.', elements.transactionMessage);
      }
      toggleButtonState(elements.saveTransactionBtn, true);
      try {
        // FIX: Using supabaseClient
        const { error } = await supabaseClient.from('transactions').insert([newTransaction]);
        if (error) throw error;
        elements.addTransactionModal.hide();
        elements.transactionForm.reset();
        await loadAndRenderData();
        showMessage('success', 'Transaction added successfully.');
      } catch (error) {
        showMessage('error', `Failed to save: ${error.message}`, elements.transactionMessage);
      } finally {
        toggleButtonState(elements.saveTransactionBtn, false, 'Save Transaction');
      }
    }

    function openEditModal(id) {
        const transaction = allTransactions.find(t => t.id === id);
        if (!transaction) return showMessage('error', 'Transaction not found.');
        document.getElementById('editTransactionId').value = transaction.id;
        document.getElementById('editTransactionType').value = transaction.type;
        document.getElementById('editTransactionDate').value = transaction.transaction_date;
        document.getElementById('editTransactionDescription').value = transaction.description;
        document.getElementById('editTransactionAmount').value = transaction.amount;
        document.getElementById('editTransactionCategory').value = transaction.category;
        document.getElementById('editTransactionMode').value = transaction.mode_of_payment;
        document.getElementById('editTransactionStatus').value = transaction.status;
        document.getElementById('editTransactionUtr').value = transaction.utr_number || '';
        document.getElementById('editTransactionBillNo').value = transaction.bill_no || '';
        elements.editTransactionModal.show();
    }

    async function handleUpdateTransaction() {
        const id = document.getElementById('editTransactionId').value;
        const updatedTransaction = {
            type: document.getElementById('editTransactionType').value,
            transaction_date: document.getElementById('editTransactionDate').value,
            description: document.getElementById('editTransactionDescription').value,
            amount: parseFloat(document.getElementById('editTransactionAmount').value),
            category: document.getElementById('editTransactionCategory').value,
            mode_of_payment: document.getElementById('editTransactionMode').value,
            status: document.getElementById('editTransactionStatus').value,
            utr_number: document.getElementById('editTransactionUtr').value,
            bill_no: document.getElementById('editTransactionBillNo').value,
        };
        toggleButtonState(elements.updateTransactionBtn, true);
        try {
            // FIX: Using supabaseClient
            const { error } = await supabaseClient.from('transactions').update(updatedTransaction).eq('id', id);
            if (error) throw error;
            elements.editTransactionModal.hide();
            await loadAndRenderData();
            showMessage('success', 'Transaction updated successfully.');
        } catch (error) {
            showMessage('error', `Update failed: ${error.message}`, elements.editTransactionMessage);
        } finally {
            toggleButtonState(elements.updateTransactionBtn, false, 'Update Transaction');
        }
    }
    
    async function handleDeleteTransaction() {
        const id = document.getElementById('editTransactionId').value;
        if (!confirm('Are you sure you want to delete this transaction?')) return;
        toggleButtonState(elements.deleteTransactionBtn, true);
        try {
            // FIX: Using supabaseClient
            const { error } = await supabaseClient.from('transactions').delete().eq('id', id);
            if (error) throw error;
            elements.editTransactionModal.hide();
            await loadAndRenderData();
            showMessage('success', 'Transaction deleted successfully.');
        } catch (error) {
            showMessage('error', `Delete failed: ${error.message}`, elements.editTransactionMessage);
        } finally {
            toggleButtonState(elements.deleteTransactionBtn, false, 'Delete');
        }
    }
    
    function handleFilterChange() {
        const searchTerm = elements.searchInput.value.toLowerCase();
        const category = elements.categoryFilter.value;
        const mode = elements.modeFilter.value;
        const status = elements.statusFilter.value;
        const date = elements.dateFilter.value;

        const filtered = allTransactions.filter(t => {
            const searchCorpus = `${t.description} ${t.utr_number || ''} ${t.bill_no || ''}`.toLowerCase();
            return (searchTerm ? searchCorpus.includes(searchTerm) : true) &&
                   (category ? t.category === category : true) &&
                   (mode ? t.mode_of_payment === mode : true) &&
                   (status ? t.status === status : true) &&
                   (date ? t.transaction_date === date : true);
        });
        renderUI(filtered);
    }
    
    // --- INITIAL PAGE LOAD & AUTH ---
    document.addEventListener('DOMContentLoaded', function() {
      // Map elements once DOM is ready
      elements = {
        addTransactionModal: new bootstrap.Modal(document.getElementById('addTransactionModal')),
        editTransactionModal: new bootstrap.Modal(document.getElementById('editTransactionModal')),
        transactionForm: document.getElementById('transactionForm'),
        saveTransactionBtn: document.getElementById('saveTransactionBtn'),
        updateTransactionBtn: document.getElementById('updateTransactionBtn'),
        deleteTransactionBtn: document.getElementById('deleteTransactionBtn'),
        logoutBtn: document.getElementById('logoutBtn'),
        searchInput: document.getElementById('searchInput'),
        categoryFilter: document.getElementById('categoryFilter'),
        modeFilter: document.getElementById('modeFilter'),
        statusFilter: document.getElementById('statusFilter'),
        dateFilter: document.getElementById('dateFilter'),
        usernameDisplay: document.getElementById('usernameDisplay'),
        message: document.getElementById('message'),
        transactionMessage: document.getElementById('transactionMessage'),
        editTransactionMessage: document.getElementById('editTransactionMessage'),
        availableBalance: document.getElementById('availableBalance'),
        totalCredits: document.getElementById('totalCredits'),
        totalDebits: document.getElementById('totalDebits'),
        allTransactionsTable: document.getElementById('allTransactionsTable'),
        creditsTable: document.getElementById('creditsTable'),
        debitsTable: document.getElementById('debitsTable'),
        allNoTransactions: document.getElementById('allNoTransactions'),
        creditsNoTransactions: document.getElementById('creditsNoTransactions'),
        debitsNoTransactions: document.getElementById('debitsNoTransactions'),
      };

      auth.onAuthStateChanged(user => {
        if (user) {
          elements.usernameDisplay.textContent = user.displayName || user.email;
          loadAndRenderData();
        } else {
          window.location.href = 'index.html';
        }
      });
      
      document.getElementById('addTransactionModal').addEventListener('show.bs.modal', () => {
        document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
      });

      elements.logoutBtn.addEventListener('click', (e) => { e.preventDefault(); auth.signOut(); });
      elements.saveTransactionBtn.addEventListener('click', handleSaveTransaction);
      elements.updateTransactionBtn.addEventListener('click', handleUpdateTransaction);
      elements.deleteTransactionBtn.addEventListener('click', handleDeleteTransaction);
      [elements.searchInput, elements.categoryFilter, elements.modeFilter, elements.statusFilter, elements.dateFilter].forEach(el => {
        el.addEventListener('input', handleFilterChange);
        el.addEventListener('change', handleFilterChange);
      });
    });
  </script>
</body>
</html>