<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Bill - Elegets Electronics</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* 1. THEME & COLORS */
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #3f37c9;
      --dark: #0c0e1c;
      --dark-light: #1a1d2e;
      --bg-input: #334155;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --border-color: #475569;
    }
    
    body {
      background-color: var(--dark);
      color: var(--text-main);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      min-height: 100vh;
    }
    
    /* 2. UI COMPONENTS */
    .navbar {
      background-color: var(--dark-light);
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .search-card, .edit-card {
      background-color: var(--dark-light);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    
    .edit-card { display: none; } /* Hidden by default */

    /* 3. INPUT VISIBILITY FIXES (High Contrast) */
    .form-control, .form-select, .input-group-text {
      background-color: var(--bg-input) !important;
      border: 1px solid var(--border-color);
      color: var(--text-main) !important;
    }
    
    .form-control:focus, .form-select:focus {
      background-color: #475569 !important;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.3);
      color: white !important;
    }

    .form-control::placeholder {
      color: var(--text-muted) !important;
      opacity: 0.7;
    }

    /* Input Group for Search */
    .input-group-text {
      color: var(--primary) !important;
      font-weight: bold;
      border-right: none;
    }
    
    /* 4. TABLE STYLES */
    .table {
      --bs-table-bg: transparent;
      --bs-table-color: var(--text-main);
      --bs-table-border-color: var(--border-color);
    }
    .table th {
      background-color: var(--primary);
      color: white;
      font-weight: 600;
    }
    .table-hover tbody tr:hover {
      background-color: rgba(255,255,255,0.05);
    }

    /* 5. SUMMARY BOX */
    .bill-summary {
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 1.5rem;
      border: 1px solid var(--border-color);
    }

    /* Loading Spinner */
    .btn-loading { pointer-events: none; position: relative; color: transparent !important; }
    .btn-loading::after {
      content: ""; position: absolute; width: 1em; height: 1em; top: 50%; left: 50%;
      margin: -0.5em 0 0 -0.5em; border: 2px solid white; border-right-color: transparent;
      border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">
        <i class="fas fa-microchip text-primary me-2"></i> Elegets
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mx-auto">
          <li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="billing.html">Billing</a></li>
          <li class="nav-item"><a class="nav-link active" href="bill_edit.html">Edit Bill</a></li>
          <li class="nav-item"><a class="nav-link" href="add_products.html">Products</a></li>
        </ul>
        <div class="d-flex">
          <div class="dropdown">
            <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown">
              <i class="fas fa-user-circle me-2"></i> <span id="usernameDisplay">Loading...</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark">
              <li><a class="dropdown-item" href="#" id="logoutBtn">Logout</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="container my-4">
    <h2 class="text-white mb-4"><i class="fas fa-edit me-2"></i> Find & Edit Bill</h2>
    
    <div class="search-card">
      <label class="form-label text-muted">Enter Bill Number</label>
      <div class="row g-2">
        <div class="col-md-8">
          <div class="input-group input-group-lg">
            <span class="input-group-text bg-dark border-secondary">ELE</span>
            <input type="text" id="billSearch" class="form-control border-start-0" placeholder="033" autofocus>
          </div>
          <div class="form-text text-muted">Type the number only (e.g. 33) or full ID.</div>
        </div>
        <div class="col-md-4">
          <button id="searchBtn" class="btn btn-primary btn-lg w-100">
            <i class="fas fa-search me-2"></i> Search
          </button>
        </div>
      </div>
    </div>
    
    <div class="edit-card" id="editBillCard">
      <div class="d-flex justify-content-between align-items-center mb-4 border-bottom border-secondary pb-3">
        <h4 class="text-white mb-0">Editing: <span class="text-primary" id="displayBillId"></span></h4>
        <span class="badge bg-warning text-dark" id="displayStatus">PENDING</span>
      </div>

      <div class="row mb-4">
        <div class="col-md-6">
          <label class="form-label">Date</label>
          <input type="date" id="editBillDate" class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">Payment Method</label>
          <select id="editPaymentMethod" class="form-select">
            <option value="Cash">Cash</option>
            <option value="UPI">UPI</option>
            <option value="Credit Card">Credit Card</option>
            <option value="Debit Card">Debit Card</option>
            <option value="Bank Transfer">Bank Transfer</option>
          </select>
        </div>
      </div>
      
      <h5 class="text-primary mb-3"><i class="fas fa-user me-2"></i> Customer</h5>
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <input type="text" id="editCustomerName" class="form-control" placeholder="Full Name">
        </div>
        <div class="col-md-4">
          <input type="tel" id="editCustomerPhone" class="form-control" placeholder="Phone">
        </div>
        <div class="col-md-4">
          <input type="email" id="editCustomerEmail" class="form-control" placeholder="Email">
        </div>
        <div class="col-md-6">
          <input type="text" id="editCustomerAddress" class="form-control" placeholder="Address">
        </div>
        <div class="col-md-3">
          <input type="text" id="editCustomerCity" class="form-control" placeholder="City">
        </div>
        <div class="col-md-3">
          <input type="text" id="editCustomerPincode" class="form-control" placeholder="Pincode">
        </div>
      </div>
      
      <h5 class="text-primary mb-3"><i class="fas fa-cart-plus me-2"></i> Add Item</h5>
      <div class="row g-2 mb-3 bg-dark p-3 rounded border border-secondary">
        <div class="col-md-5">
          <input type="text" id="addProductCode" class="form-control" placeholder="Product Code (e.g. 101)">
        </div>
        <div class="col-md-3">
          <input type="number" id="addProductQty" class="form-control" placeholder="Qty" min="1" value="1">
        </div>
        <div class="col-md-4">
          <button id="addProductBtn" class="btn btn-outline-light w-100">
            <i class="fas fa-plus me-2"></i> Add to Bill
          </button>
        </div>
      </div>
      
      <div class="table-responsive mb-4">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Product</th>
              <th class="text-end">Price</th>
              <th class="text-center" style="width: 100px;">Qty</th>
              <th class="text-end">Total</th>
              <th class="text-center">Action</th>
            </tr>
          </thead>
          <tbody id="editBillItems">
            </tbody>
        </table>
      </div>
      
      <div class="row mt-4">
        <div class="col-md-6">
          <label class="form-label text-muted">Notes</label>
          <textarea id="editAdditionalNotes" class="form-control" rows="4"></textarea>
        </div>
        <div class="col-md-6">
          <div class="bill-summary">
            <div class="d-flex justify-content-between mb-2">
                <span>Subtotal</span>
                <span>₹<span id="editSubtotal">0.00</span></span>
            </div>
            
            <div class="input-group input-group-sm mb-2">
                <span class="input-group-text border-secondary bg-dark text-muted">Discount ₹</span>
                <input type="number" id="editDiscount" class="form-control text-end" value="0">
            </div>
            
            <div class="input-group input-group-sm mb-2">
                <span class="input-group-text border-secondary bg-dark text-muted">Delivery ₹</span>
                <input type="number" id="editDelivery" class="form-control text-end" value="0">
            </div>
            
            <hr class="border-secondary">
            
            <div class="d-flex justify-content-between mb-3 fw-bold fs-5">
                <span class="text-white">Grand Total</span>
                <span class="text-success">₹<span id="editGrandTotal">0.00</span></span>
            </div>
            
            <div class="input-group mb-3">
                <span class="input-group-text border-secondary bg-dark text-muted">Paid Amount ₹</span>
                <input type="number" id="editPaid" class="form-control text-end fw-bold text-white" value="0">
            </div>
            
            <div class="d-flex justify-content-between fw-bold text-warning">
                <span>Balance Due</span>
                <span>₹<span id="editBalance">0.00</span></span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="d-flex justify-content-end mt-4 gap-3 pt-3 border-top border-secondary">
        <button id="deleteBillBtn" class="btn btn-outline-danger">
          <i class="fas fa-trash me-2"></i> Delete
        </button>
        <button id="updateBillBtn" class="btn btn-success px-4">
          <i class="fas fa-save me-2"></i> Update Bill
        </button>
        <button id="printBillBtn" class="btn btn-primary px-4">
          <i class="fas fa-print me-2"></i> Print
        </button>
      </div>
    </div>
  </div>

  <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content bg-dark border border-secondary text-white">
        <div class="modal-header border-bottom border-secondary">
          <h5 class="modal-title text-danger">Delete Bill?</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to permanently delete this bill?</p>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="confirmDeleteCheck">
            <label class="form-check-label" for="confirmDeleteCheck">Yes, delete it.</label>
          </div>
        </div>
        <div class="modal-footer border-top border-secondary">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>

  <script>
    // ========================
    // 1. CONFIGURATION
    // ========================
    const firebaseConfig = {
      apiKey: "AIzaSyASjV5eTtSWFih3pP8aJKzztj7PsxEW3Sg",
      authDomain: "elegets-bill-desk.firebaseapp.com",
      projectId: "elegets-bill-desk",
      storageBucket: "elegets-bill-desk.appspot.com",
      messagingSenderId: "716287582493",
      appId: "1:716287582493:web:28e4e23ef312aefb77c1f4"
    };

    const supabaseUrl = 'https://oborglvlgafnglzqczot.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ib3JnbHZsZ2FmbmdsenFjem90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MjE2MzEsImV4cCI6MjA2ODQ5NzYzMX0.dDt-_pcuEcyuvBlNvpMCspPXW04AU-KeFjIpQcWXXXk';

    // Initialize Services
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    // FIX: Renamed variable to avoid conflict
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Global State
    let currentBill = null;
    let deleteModal;

    // ========================
    // 2. INITIALIZATION
    // ========================
    document.addEventListener('DOMContentLoaded', function() {
        // Auth Guard
        auth.onAuthStateChanged(user => {
            if (!user) window.location.href = 'index.html';
            else document.getElementById('usernameDisplay').textContent = user.displayName || 'Admin';
        });

        // Init Modal
        deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));

        // Event Listeners
        document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());
        document.getElementById('searchBtn').addEventListener('click', searchBill);
        document.getElementById('billSearch').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchBill();
        });

        // Add Product
        document.getElementById('addProductBtn').addEventListener('click', addProductToBill);
        // Buttons
        document.getElementById('updateBillBtn').addEventListener('click', updateBill);
        document.getElementById('printBillBtn').addEventListener('click', generateInvoicePDF);
        document.getElementById('deleteBillBtn').addEventListener('click', showDeleteConfirmation);
        document.getElementById('confirmDeleteBtn').addEventListener('click', deleteBill);

        // Calculations
        ['editDiscount', 'editDelivery', 'editPaid'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateEditBillSummary);
        });
    });

    // ========================
    // 3. CORE LOGIC
    // ========================

    async function searchBill() {
        const btn = document.getElementById('searchBtn');
        const searchInput = document.getElementById('billSearch');
        let val = searchInput.value.trim();

        if (!val) return alert('Please enter a bill number');

        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        // -----------------------------------------------------
        // LOGIC FIX: Auto-prefixing 'ELE'
        // -----------------------------------------------------
        let numericPart = val.replace(/^ELE/i, '');
        if (/^\d+$/.test(numericPart)) {
            numericPart = numericPart.padStart(3, '0');
        }
        const finalBillNumber = 'ELE' + numericPart;
        // -----------------------------------------------------

        try {
            const { data, error } = await supabaseClient
                .from('bills')
                .select('*')
                .ilike('bill_number', finalBillNumber) 
                .single();

            if (error) throw error;

            if (data) {
                currentBill = data;
                displayBill(data);
                document.getElementById('editBillCard').style.display = 'block';
                document.getElementById('editBillCard').scrollIntoView({ behavior: 'smooth' });
            } else {
                alert('Bill not found!');
            }
        } catch (error) {
            console.error(error);
            alert('Bill not found. Please check the number.');
        } finally {
            btn.innerHTML = '<i class="fas fa-search me-2"></i> Search';
        }
    }

    function displayBill(bill) {
        document.getElementById('displayBillId').textContent = bill.bill_number;
        document.getElementById('displayStatus').textContent = bill.status || 'PENDING';
        
        document.getElementById('editBillDate').value = bill.bill_date;
        document.getElementById('editPaymentMethod').value = bill.payment_method || 'Cash';

        // Customer
        const cust = bill.customer || {};
        document.getElementById('editCustomerName').value = cust.name || '';
        document.getElementById('editCustomerPhone').value = cust.phone || '';
        document.getElementById('editCustomerEmail').value = cust.email || '';
        document.getElementById('editCustomerAddress').value = cust.address || '';
        document.getElementById('editCustomerCity').value = cust.city || '';
        document.getElementById('editCustomerPincode').value = cust.pincode || '';

        // Items
        renderItemsTable();

        // Financials
        document.getElementById('editDiscount').value = bill.discount || 0;
        document.getElementById('editDelivery').value = bill.delivery_charges || 0;
        document.getElementById('editPaid').value = bill.amount_paid || 0;
        document.getElementById('editAdditionalNotes').value = bill.notes || '';

        updateEditBillSummary();
    }

    function renderItemsTable() {
        const tbody = document.getElementById('editBillItems');
        tbody.innerHTML = '';

        if (currentBill.items && currentBill.items.length > 0) {
            currentBill.items.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="text-white">${item.name} <div class="small text-muted">${item.code}</div></td>
                    <td class="text-end text-white">₹${item.price.toFixed(2)}</td>
                    <td class="text-center">
                        <input type="number" class="form-control form-control-sm text-center bg-dark text-white border-secondary" 
                               value="${item.qty}" min="1" onchange="updateItemQty(${index}, this.value)">
                    </td>
                    <td class="text-end text-white">₹${item.total.toFixed(2)}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-danger border-0" onclick="removeBillItem(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No items in this bill</td></tr>';
        }
    }

    window.updateItemQty = function(index, newQty) {
        newQty = parseInt(newQty);
        if (newQty < 1) newQty = 1;
        currentBill.items[index].qty = newQty;
        currentBill.items[index].total = newQty * currentBill.items[index].price;
        renderItemsTable();
        updateEditBillSummary();
    };

    window.removeBillItem = function(index) {
        if(!confirm("Remove item?")) return;
        currentBill.items.splice(index, 1);
        renderItemsTable();
        updateEditBillSummary();
    };

    async function addProductToBill() {
        const code = document.getElementById('addProductCode').value.trim();
        const qty = parseInt(document.getElementById('addProductQty').value) || 1;

        if (!code) return alert('Enter product code');

        try {
            const { data, error } = await supabaseClient
                .from('products')
                .select('*')
                .eq('code', code)
                .single();

            if (error) throw error;

            if (data) {
                if (!currentBill.items) currentBill.items = [];
                
                const existing = currentBill.items.find(i => i.code === code);
                if (existing) {
                    existing.qty += qty;
                    existing.total = existing.qty * existing.price;
                } else {
                    currentBill.items.push({
                        code: data.code,
                        name: data.name,
                        price: data.sale_price,
                        qty: qty,
                        total: qty * data.sale_price
                    });
                }
                
                document.getElementById('addProductCode').value = '';
                document.getElementById('addProductQty').value = '1';
                renderItemsTable();
                updateEditBillSummary();
            } else {
                alert('Product not found');
            }
        } catch (err) {
            alert('Product not found or error: ' + err.message);
        }
    }

    function updateEditBillSummary() {
        if (!currentBill) return;

        const subtotal = currentBill.items.reduce((sum, item) => sum + item.total, 0);
        const discount = parseFloat(document.getElementById('editDiscount').value) || 0;
        const delivery = parseFloat(document.getElementById('editDelivery').value) || 0;
        const paid = parseFloat(document.getElementById('editPaid').value) || 0;

        const grandTotal = Math.max(0, subtotal + delivery - discount);
        const balance = Math.max(0, grandTotal - paid);

        document.getElementById('editSubtotal').textContent = subtotal.toFixed(2);
        document.getElementById('editGrandTotal').textContent = grandTotal.toFixed(2);
        document.getElementById('editBalance').textContent = balance.toFixed(2);
        
        currentBill.subtotal = subtotal;
        currentBill.discount = discount;
        currentBill.delivery_charges = delivery;
        currentBill.grand_total = grandTotal;
        currentBill.amount_paid = paid;
        currentBill.balance = balance;
        currentBill.status = balance <= 0 ? 'paid' : 'pending';
    }

    async function updateBill() {
        if (!currentBill) return;
        
        const btn = document.getElementById('updateBillBtn');
        btn.classList.add('btn-loading');

        currentBill.customer = {
            name: document.getElementById('editCustomerName').value,
            phone: document.getElementById('editCustomerPhone').value,
            email: document.getElementById('editCustomerEmail').value,
            address: document.getElementById('editCustomerAddress').value,
            city: document.getElementById('editCustomerCity').value,
            pincode: document.getElementById('editCustomerPincode').value
        };
        
        currentBill.bill_date = document.getElementById('editBillDate').value;
        currentBill.payment_method = document.getElementById('editPaymentMethod').value;
        currentBill.notes = document.getElementById('editAdditionalNotes').value;

        try {
            const { error } = await supabaseClient
                .from('bills')
                .update(currentBill)
                .eq('bill_number', currentBill.bill_number);

            if (error) throw error;
            
            alert('Bill updated successfully!');
            document.getElementById('displayStatus').textContent = currentBill.status.toUpperCase();
        } catch (err) {
            alert('Update failed: ' + err.message);
        } finally {
            btn.classList.remove('btn-loading');
        }
    }

    function showDeleteConfirmation() {
        if (!currentBill) return;
        document.getElementById('confirmDeleteCheck').checked = false;
        deleteModal.show();
    }

    async function deleteBill() {
        if (!document.getElementById('confirmDeleteCheck').checked) {
            return alert("Please check the confirmation box.");
        }

        try {
            const { error } = await supabaseClient
                .from('bills')
                .delete()
                .eq('bill_number', currentBill.bill_number);

            if (error) throw error;

            alert("Bill Deleted.");
            deleteModal.hide();
            location.reload();
        } catch (err) {
            alert("Delete failed: " + err.message);
        }
    }

    // --- PDF GENERATION WITH ORIGINAL FORMAT ---
    async function generateInvoicePDF() {
        if (!window.jspdf) return alert("PDF Engine loading...");
        const btn = document.getElementById('printBillBtn');
        btn.classList.add('btn-loading');

        // Colorful company details
        const companyDetails = {
            name: "ELEGETS ELECTRONICS",
            address: "Flat No: 102, Vishaka Valley Heights1, Veterinary Colony Opp MRO Office",
            city: "Visakhapatnam, Andhra Pradesh - 530040",
            website: "www.gostore.app/elegets",
            contactNumber: "+91 63020 85024",
            email: "contact.elegets@gmail.com",
            GSTIN: "#",
            colors: {
                primary: "#4361ee",
                secondary: "#3a56d4",
                accent: "#7209b7",
                success: "#38a169",
                danger: "#e53e3e",
                lightBg: "#f8fafc"
            }
        };

        const div = document.createElement('div');
        div.style.width = '210mm';
        div.style.minHeight = '297mm';
        div.style.padding = '0';
        div.style.background = 'white';
        div.style.color = '#2d3748';
        div.style.fontFamily = 'Arial, sans-serif';
        div.style.position = 'fixed';
        div.style.top = '-10000px';

        div.innerHTML = `
            <style>
                .colorful-invoice { width: 100%; max-width: 800px; margin: 0 auto; background: #fff; padding-bottom: 20px; }
                .invoice-header { background: linear-gradient(135deg, ${companyDetails.colors.primary} 0%, ${companyDetails.colors.secondary} 100%); padding: 25px 30px; color: white; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid ${companyDetails.colors.accent}; }
                .company-name { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
                .invoice-content { padding: 25px 30px; }
                .columns { display: flex; gap: 20px; margin-bottom: 20px; }
                .column { flex: 1; background: ${companyDetails.colors.lightBg}; padding: 15px; border-radius: 8px; border-left: 4px solid ${companyDetails.colors.primary}; }
                .items-table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 12px; }
                .items-table th { background: ${companyDetails.colors.primary}; color: white; padding: 10px; text-align: left; }
                .items-table td { padding: 10px; border-bottom: 1px solid #eee; }
                .summary { margin-left: auto; width: 250px; background: white; padding: 15px; border: 1px solid #eee; border-radius: 8px; }
                .summary-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; }
                .total-row { font-weight: bold; color: ${companyDetails.colors.primary}; font-size: 14px; border-top: 1px solid #eee; padding-top: 5px; margin-top: 5px; }
                .footer { text-align: center; margin-top: 30px; font-size: 10px; color: #888; border-top: 1px dashed #ccc; padding-top: 10px; }
            </style>
            
            <div class="colorful-invoice">
                <div class="invoice-header">
                    <div>
                        <div class="company-name">${companyDetails.name}</div>
                        <div style="font-size:10px; opacity:0.9;">${companyDetails.address}<br>${companyDetails.city}<br>${companyDetails.email}</div>
                    </div>
                    <div style="text-align:right;">
                        <h1 style="margin:0; font-size:28px;">INVOICE</h1>
                        <div style="font-size:14px; margin-top:5px;">#${currentBill.bill_number}</div>
                        <div style="background:${currentBill.balance <= 0 ? companyDetails.colors.success : companyDetails.colors.danger}; color:white; display:inline-block; padding:3px 10px; border-radius:10px; font-size:10px; margin-top:5px;">
                            ${currentBill.balance <= 0 ? 'PAID' : 'PENDING'}
                        </div>
                    </div>
                </div>
                
                <div class="invoice-content">
                    <div class="columns">
                        <div class="column">
                            <h4 style="margin:0 0 10px 0; color:${companyDetails.colors.primary}; font-size:14px;">Bill To</h4>
                            <div style="font-size:12px;">
                                <strong>${currentBill.customer?.name || ''}</strong><br>
                                ${currentBill.customer?.phone || ''}<br>
                                ${currentBill.customer?.city || ''}
                            </div>
                        </div>
                        <div class="column">
                            <h4 style="margin:0 0 10px 0; color:${companyDetails.colors.primary}; font-size:14px;">Details</h4>
                            <div style="font-size:12px;">
                                Date: ${new Date(currentBill.bill_date).toLocaleDateString()}<br>
                                Method: ${currentBill.payment_method}<br>
                                GSTIN: ${companyDetails.GSTIN}
                            </div>
                        </div>
                    </div>

                    <table class="items-table">
                        <thead><tr><th>Item</th><th style="text-align:right;">Price</th><th style="text-align:center;">Qty</th><th style="text-align:right;">Total</th></tr></thead>
                        <tbody>
                            ${currentBill.items.map(i => `
                                <tr>
                                    <td>${i.name}</td>
                                    <td style="text-align:right;">₹${i.price.toFixed(2)}</td>
                                    <td style="text-align:center;">${i.qty}</td>
                                    <td style="text-align:right;">₹${i.total.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="summary">
                        <div class="summary-row"><span>Subtotal:</span><span>₹${currentBill.subtotal.toFixed(2)}</span></div>
                        ${currentBill.discount > 0 ? `<div class="summary-row" style="color:${companyDetails.colors.danger}"><span>Discount:</span><span>- ₹${currentBill.discount.toFixed(2)}</span></div>` : ''}
                        ${currentBill.delivery_charges > 0 ? `<div class="summary-row" style="color:${companyDetails.colors.success}"><span>Delivery:</span><span>+ ₹${currentBill.delivery_charges.toFixed(2)}</span></div>` : ''}
                        <div class="summary-row total-row"><span>Total:</span><span>₹${currentBill.grand_total.toFixed(2)}</span></div>
                        <div class="summary-row"><span>Paid:</span><span>₹${currentBill.amount_paid.toFixed(2)}</span></div>
                        <div class="summary-row" style="font-weight:bold; color:${currentBill.balance <= 0 ? companyDetails.colors.success : companyDetails.colors.danger}">
                            <span>Balance:</span><span>₹${currentBill.balance.toFixed(2)}</span>
                        </div>
                    </div>

                    ${currentBill.notes ? `<div style="margin-top:20px; font-size:12px; background:${companyDetails.colors.lightBg}; padding:10px; border-radius:5px;"><strong>Notes:</strong> ${currentBill.notes}</div>` : ''}

                    <div class="footer">
                        Thank you for your business!<br>
                        ${companyDetails.website} | ${companyDetails.contactNumber}
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(div);

        try {
            const { jsPDF } = window.jspdf;
            const canvas = await html2canvas(div, { scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff' });
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            
            let heightLeft = pdfHeight;
            let position = 0;
            const pageHeight = pdf.internal.pageSize.getHeight();

            pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
            heightLeft -= pageHeight;

            while (heightLeft >= 0) {
                position = heightLeft - pdfHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                heightLeft -= pageHeight;
            }

            pdf.save(`Invoice_${currentBill.bill_number}.pdf`);
        } catch (e) {
            console.error(e);
            alert("PDF Generation Failed");
        } finally {
            document.body.removeChild(div);
            btn.classList.remove('btn-loading');
        }
    }
  </script>
</body>
</html>