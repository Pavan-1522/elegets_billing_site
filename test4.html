<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fund Management - Elegets Electronics</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #3f37c9;
      --dark: #0c0e1c;
      --dark-light: #1a1d2e;
      --light: #f8f9fa;
      --success: #4cc9f0;
      --warning: #f8961e;
      --danger: #f72585;
      --credit: #4ade80;
      --debit: #f87171;
    }
    
    body {
      background-color: var(--dark);
      color: var(--light);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .navbar {
      background-color: var(--dark-light);
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .navbar-brand {
      font-weight: 700;
      color: var(--light);
      display: flex;
      align-items: center;
    }
    
    .navbar-brand i {
      color: var(--primary);
      margin-right: 10px;
    }
    
    .nav-link {
      color: rgba(255, 255, 255, 0.8);
      font-weight: 500;
      padding: 0.5rem 1rem;
      transition: all 0.3s ease;
    }
    
    .nav-link:hover, .nav-link.active {
      color: var(--light);
    }
    
    .nav-link.active {
      color: var(--primary);
    }
    
    .card {
      background-color: var(--dark-light);
      border: none;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      margin-bottom: 2rem;
    }
    
    .card-header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 1.5rem;
      border-bottom: none;
    }
    
    .card-body {
      padding: 2rem;
    }
    
    .form-label {
      color: rgba(255, 255, 255, 0.9);
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    
    .form-control {
      background-color: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--light);
      padding: 0.75rem 1rem;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      background-color: rgba(255, 255, 255, 0.08);
      border-color: var(--primary);
      box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
      color: var(--light);
    }
    
    .form-control::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }
    
    .btn-primary {
      background-color: var(--primary);
      border: none;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    .btn-primary:active {
      transform: translateY(0);
    }
    
    #message {
      margin-top: 1.5rem;
      padding: 1rem;
      border-radius: 8px;
      font-weight: 500;
    }
    
    .success-message {
      background-color: rgba(76, 201, 240, 0.1);
      border-left: 4px solid var(--success);
      color: var(--success);
    }
    
    .error-message {
      background-color: rgba(247, 37, 133, 0.1);
      border-left: 4px solid var(--danger);
      color: var(--danger);
    }
    
    .warning-message {
      background-color: rgba(248, 150, 30, 0.1);
      border-left: 4px solid var(--warning);
      color: var(--warning);
    }
    
    .footer {
      background-color: var(--dark-light);
      color: rgba(255, 255, 255, 0.7);
      padding: 2rem 0;
      margin-top: auto;
    }
    
    .footer a {
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      transition: all 0.3s ease;
    }
    
    .footer a:hover {
      color: var(--light);
    }
    
    .footer-title {
      color: var(--light);
      font-weight: 600;
      margin-bottom: 1rem;
    }
    
    .social-icons a {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 50%;
      margin-right: 10px;
      transition: all 0.3s ease;
    }
    
    .social-icons a:hover {
      background-color: var(--primary);
      color: white;
      transform: translateY(-3px);
    }
    
    .copyright {
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      padding-top: 1.5rem;
      margin-top: 2rem;
      text-align: center;
    }
    
    .input-group-text {
      background-color: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.7);
    }
    
    .page-title {
      margin: 2rem 0;
      position: relative;
      padding-bottom: 1rem;
    }
    
    .page-title:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 60px;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-radius: 2px;
    }
    
    /* Fund Management Specific Styles */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .summary-card {
      background-color: var(--dark-light);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
      transition: transform 0.3s ease;
    }
    
    .summary-card:hover {
      transform: translateY(-5px);
    }
    
    .summary-card.balance {
      border-left: 4px solid var(--primary);
    }
    
    .summary-card.credits {
      border-left: 4px solid var(--credit);
    }
    
    .summary-card.debits {
      border-left: 4px solid var(--debit);
    }
    
    .summary-card h3 {
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 0.5rem;
    }
    
    .summary-card .amount {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .summary-card .balance .amount {
      color: var(--primary);
    }
    
    .summary-card .credits .amount {
      color: var(--credit);
    }
    
    .summary-card .debits .amount {
      color: var(--debit);
    }
    
    .summary-card .trend {
      display: flex;
      align-items: center;
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.6);
    }
    
    .summary-card .trend.up {
      color: var(--credit);
    }
    
    .summary-card .trend.down {
      color: var(--debit);
    }
    
    .nav-pills .nav-link {
      color: rgba(255, 255, 255, 0.7);
      background-color: rgba(255, 255, 255, 0.05);
      margin-right: 0.5rem;
      border-radius: 8px;
    }
    
    .nav-pills .nav-link.active {
      background-color: var(--primary);
      color: white;
    }
    
    .transaction-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .transaction-table thead th {
      background-color: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.8);
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .transaction-table tbody tr {
      transition: all 0.2s ease;
    }
    
    .transaction-table tbody tr:hover {
      background-color: rgba(255, 255, 255, 0.03);
    }
    
    .transaction-table tbody td {
      padding: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      vertical-align: middle;
    }
    
    .transaction-table .badge {
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.75rem;
    }
    
    .badge-credit {
      background-color: rgba(74, 222, 128, 0.1);
      color: var(--credit);
    }
    
    .badge-debit {
      background-color: rgba(248, 113, 113, 0.1);
      color: var(--debit);
    }
    
    .amount-cell {
      font-weight: 600;
    }
    
    .amount-cell.credit {
      color: var(--credit);
    }
    
    .amount-cell.debit {
      color: var(--debit);
    }
    
    .action-btns .btn {
      padding: 0.375rem 0.75rem;
      margin-right: 0.5rem;
    }
    
    .no-transactions {
      text-align: center;
      padding: 2rem;
      color: rgba(255, 255, 255, 0.5);
    }
    
    .search-filter {
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    
    @media (max-width: 768px) {
      .card-body {
        padding: 1.5rem;
      }
      
      .summary-cards {
        grid-template-columns: 1fr;
      }
      
      .transaction-table thead {
        display: none;
      }
      
      .transaction-table tbody tr {
        display: block;
        margin-bottom: 1rem;
        border-radius: 8px;
        background-color: rgba(255, 255, 255, 0.03);
      }
      
      .transaction-table tbody td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        border-bottom: none;
      }
      
      .transaction-table tbody td::before {
        content: attr(data-label);
        font-weight: 600;
        margin-right: 1rem;
        color: rgba(255, 255, 255, 0.6);
      }
    }

    /* Loading spinner */
    .spinner-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Empty state styles */
    .empty-state {
      text-align: center;
      padding: 2rem;
    }
    
    .empty-state i {
      font-size: 3rem;
      color: rgba(255, 255, 255, 0.2);
      margin-bottom: 1rem;
    }
    
    .empty-state h4 {
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 0.5rem;
    }
    
    .empty-state p {
      color: rgba(255, 255, 255, 0.5);
    }

    /* Pagination styles */
    .pagination-container {
      display: flex;
      justify-content: center;
      margin-top: 1.5rem;
    }
    
    .page-info {
      color: rgba(255, 255, 255, 0.7);
      margin: 0 1rem;
      align-self: center;
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <i class="fas fa-microchip"></i>
        <span>Elegets Electronics</span>
      </a>
      
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mx-auto">
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html"><i class="fas fa-home me-2"></i> Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="billing.html"><i class="fas fa-file-invoice-dollar me-2"></i> Billing</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="bill_edit.html"><i class="fas fa-edit me-2"></i> Edit Bill</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="add_products.html"><i class="fas fa-boxes me-2"></i> Products</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="edit_product.html"><i class="fas fa-boxes me-2"></i> Products [Edit]</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="fund_management.html"><i class="fas fa-wallet me-2"></i> Funds</a>
          </li>
        </ul>
        
        <div class="d-flex">
          <div class="dropdown">
            <button class="btn btn-outline-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown">
              <i class="fas fa-user-circle me-2"></i>
              <span id="usernameDisplay">pavan@elegets.com</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i> Profile</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i> Logout</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="container my-4 flex-grow-1">
    <h1 class="page-title">Fund Management</h1>
    
    <!-- Summary Cards -->
    <div class="summary-cards">
      <div class="summary-card balance">
        <h3>Available Balance</h3>
        <div class="amount" id="availableBalance">
          <div class="spinner-container">
            <div class="spinner"></div>
          </div>
        </div>
        <div class="trend">
          <i class="fas fa-info-circle me-2"></i>
          <span>Current funds available</span>
        </div>
      </div>
      
      <div class="summary-card credits">
        <h3>Total Credits</h3>
        <div class="amount" id="totalCredits">
          <div class="spinner-container">
            <div class="spinner"></div>
          </div>
        </div>
        <div class="trend up">
          <i class="fas fa-arrow-up me-2"></i>
          <span>All incoming payments</span>
        </div>
      </div>
      
      <div class="summary-card debits">
        <h3>Total Debits</h3>
        <div class="amount" id="totalDebits">
          <div class="spinner-container">
            <div class="spinner"></div>
          </div>
        </div>
        <div class="trend down">
          <i class="fas fa-arrow-down me-2"></i>
          <span>All expenses & payments</span>
        </div>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="mb-0"><i class="fas fa-exchange-alt me-2"></i> Transaction Records</h3>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
          <i class="fas fa-plus me-2"></i> Add Transaction
        </button>
      </div>
      <div class="card-body">
        <!-- Transaction Tabs -->
        <ul class="nav nav-pills mb-4" id="transactionTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="all-tab" data-bs-toggle="pill" data-bs-target="#all" type="button" role="tab">All Transactions</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="credits-tab" data-bs-toggle="pill" data-bs-target="#credits" type="button" role="tab">Credits</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="debits-tab" data-bs-toggle="pill" data-bs-target="#debits" type="button" role="tab">Debits</button>
          </li>
        </ul>
        
        <!-- Search and Filter -->
        <div class="search-filter">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" id="searchInput" class="form-control" placeholder="Search transactions...">
              </div>
            </div>
            <div class="col-md-3">
              <select id="categoryFilter" class="form-select">
                <option value="">All Categories</option>
                <option value="customer_payment">Customer Payment</option>
                <option value="supplier_payment">Supplier Payment</option>
                <option value="expense">Expense</option>
                <option value="investment">Investment</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="col-md-3">
              <input type="date" id="dateFilter" class="form-control">
            </div>
          </div>
        </div>
        
        <!-- Tab Content -->
        <div class="tab-content" id="transactionTabsContent">
          <!-- All Transactions Tab -->
          <div class="tab-pane fade show active" id="all" role="tabpanel">
            <div class="table-responsive">
              <table class="transaction-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Reference</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="allTransactionsTable">
                  <tr>
                    <td colspan="7" class="text-center py-4">
                      <div class="spinner-container">
                        <div class="spinner"></div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div id="allNoTransactions" class="no-transactions" style="display: none;">
                <i class="fas fa-exchange-alt fa-3x mb-3"></i>
                <h4>No transactions found</h4>
                <p>Add your first transaction to get started</p>
              </div>
            </div>
            <div class="pagination-container">
              <button class="btn btn-outline-primary" id="prevPageBtn" disabled>
                <i class="fas fa-chevron-left"></i> Previous
              </button>
              <span class="page-info" id="pageInfo">Page 1 of 1</span>
              <button class="btn btn-outline-primary" id="nextPageBtn" disabled>
                Next <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
          
          <!-- Credits Tab -->
          <div class="tab-pane fade" id="credits" role="tabpanel">
            <div class="table-responsive">
              <table class="transaction-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Reference</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="creditsTable">
                  <tr>
                    <td colspan="6" class="text-center py-4">
                      <div class="spinner-container">
                        <div class="spinner"></div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div id="creditsNoTransactions" class="no-transactions" style="display: none;">
                <i class="fas fa-money-bill-wave fa-3x mb-3"></i>
                <h4>No credit transactions found</h4>
                <p>Add your first credit transaction to get started</p>
              </div>
            </div>
          </div>
          
          <!-- Debits Tab -->
          <div class="tab-pane fade" id="debits" role="tabpanel">
            <div class="table-responsive">
              <table class="transaction-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Reference</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="debitsTable">
                  <tr>
                    <td colspan="6" class="text-center py-4">
                      <div class="spinner-container">
                        <div class="spinner"></div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div id="debitsNoTransactions" class="no-transactions" style="display: none;">
                <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                <h4>No debit transactions found</h4>
                <p>Add your first debit transaction to get started</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Add Transaction Modal -->
  <div class="modal fade" id="addTransactionModal" tabindex="-1" aria-labelledby="addTransactionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addTransactionModalLabel">Add New Transaction</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="transactionForm">
            <div class="mb-3">
              <label for="transactionType" class="form-label">Transaction Type</label>
              <select class="form-select" id="transactionType" required>
                <option value="">Select type</option>
                <option value="credit">Credit (Income/Deposit)</option>
                <option value="debit">Debit (Expense/Payment)</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="transactionAmount" class="form-label">Amount (₹)</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-rupee-sign"></i></span>
                <input type="number" class="form-control" id="transactionAmount" placeholder="0.00" step="0.01" min="0" required>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="transactionDescription" class="form-label">Description</label>
              <input type="text" class="form-control" id="transactionDescription" placeholder="What's this transaction for?" required>
            </div>
            
            <div class="mb-3">
              <label for="transactionCategory" class="form-label">Category</label>
              <select class="form-select" id="transactionCategory" required>
                <option value="">Select category</option>
                <option value="customer_payment">Customer Payment</option>
                <option value="supplier_payment">Supplier Payment</option>
                <option value="expense">Business Expense</option>
                <option value="investment">Investment</option>
                <option value="other">Other</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="transactionReference" class="form-label">Reference (Optional)</label>
              <input type="text" class="form-control" id="transactionReference" placeholder="Invoice #, Receipt #, etc.">
            </div>
            
            <div id="transactionMessage" class="mb-3"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveTransactionBtn">
            <span id="saveBtnText">Save Transaction</span>
            <span id="saveBtnSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Transaction Modal -->
  <div class="modal fade" id="editTransactionModal" tabindex="-1" aria-labelledby="editTransactionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editTransactionModalLabel">Edit Transaction</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editTransactionForm">
            <input type="hidden" id="editTransactionId">
            <div class="mb-3">
              <label for="editTransactionType" class="form-label">Transaction Type</label>
              <select class="form-select" id="editTransactionType" required>
                <option value="credit">Credit (Income/Deposit)</option>
                <option value="debit">Debit (Expense/Payment)</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="editTransactionAmount" class="form-label">Amount (₹)</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-rupee-sign"></i></span>
                <input type="number" class="form-control" id="editTransactionAmount" placeholder="0.00" step="0.01" min="0" required>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="editTransactionDescription" class="form-label">Description</label>
              <input type="text" class="form-control" id="editTransactionDescription" placeholder="What's this transaction for?" required>
            </div>
            
            <div class="mb-3">
              <label for="editTransactionCategory" class="form-label">Category</label>
              <select class="form-select" id="editTransactionCategory" required>
                <option value="customer_payment">Customer Payment</option>
                <option value="supplier_payment">Supplier Payment</option>
                <option value="expense">Business Expense</option>
                <option value="investment">Investment</option>
                <option value="other">Other</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="editTransactionReference" class="form-label">Reference (Optional)</label>
              <input type="text" class="form-control" id="editTransactionReference" placeholder="Invoice #, Receipt #, etc.">
            </div>
            
            <div id="editTransactionMessage" class="mb-3"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger me-auto" id="deleteTransactionBtn">
            <span id="deleteBtnText">Delete</span>
            <span id="deleteBtnSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="updateTransactionBtn">
            <span id="updateBtnText">Update Transaction</span>
            <span id="updateBtnSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 mb-4">
          <h5 class="footer-title">Elegets Electronics</h5>
          <p>Your trusted partner for all electronic components and devices. Quality products at competitive prices.</p>
          <div class="social-icons mt-3">
            <a href="#"><i class="fab fa-facebook-f"></i></a>
            <a href="#"><i class="fab fa-twitter"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
            <a href="#"><i class="fab fa-linkedin-in"></i></a>
          </div>
        </div>
        <div class="col-lg-2 col-md-6 mb-4">
          <h5 class="footer-title">Quick Links</h5>
          <ul class="list-unstyled">
            <li class="mb-2"><a href="#"><i class="fas fa-chevron-right me-2"></i> Home</a></li>
            <li class="mb-2"><a href="#"><i class="fas fa-chevron-right me-2"></i> Products</a></li>
            <li class="mb-2"><a href="#"><i class="fas fa-chevron-right me-2"></i> Billing</a></li>
            <li class="mb-2"><a href="#"><i class="fas fa-chevron-right me-2"></i> About Us</a></li>
          </ul>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
          <h5 class="footer-title">Support</h5>
          <ul class="list-unstyled">
            <li class="mb-2"><a href="#"><i class="fas fa-chevron-right me-2"></i> Contact Us</a></li>
            <li class="mb-2"><a href="#"><i class="fas fa-chevron-right me-2"></i> FAQs</a></li>
            <li class="mb-2"><a href="#"><i class="fas fa-chevron-right me-2"></i> Privacy Policy</a></li>
            <li class="mb-2"><a href="#"><i class="fas fa-chevron-right me-2"></i> Terms of Service</a></li>
          </ul>
        </div>
        <div class="col-lg-3 mb-4">
          <h5 class="footer-title">Contact Info</h5>
          <ul class="list-unstyled">
            <li class="mb-2"><i class="fas fa-map-marker-alt me-2"></i> 123 Tech Park, Bangalore, India</li>
            <li class="mb-2"><i class="fas fa-phone me-2"></i> +91 9876543210</li>
            <li class="mb-2"><i class="fas fa-envelope me-2"></i> info@elegets.com</li>
            <li class="mb-2"><i class="fas fa-clock me-2"></i> Mon-Sat: 9:00 AM - 6:00 PM</li>
          </ul>
        </div>
      </div>
      <div class="copyright">
        <p class="mb-0">&copy; 2023 Elegets Electronics. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyASjV5eTtSWFih3pP8aJKzztj7PsxEW3Sg",
      authDomain: "elegets-bill-desk.firebaseapp.com",
      projectId: "elegets-bill-desk",
      storageBucket: "elegets-bill-desk.appspot.com",
      messagingSenderId: "716287582493",
      appId: "1:716287582493:web:28e4e23ef312aefb77c1f4"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Check authentication state
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = 'index.html';
      }
    });
    
    // Initialize Supabase with error handling
    let supabase;
    try {
      supabase = window.supabase.createClient(
        'https://oborglvlgafnglzqczot.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ib3JnbHZsZ2FmbmdsenFjem90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MjE2MzEsImV4cCI6MjA2ODQ5NzYzMX0.dDt-_pcuEcyuvBlNvpMCspPXW04AU-KeFjIpQcWXXXk'
      );
    } catch (error) {
      console.error('Failed to initialize Supabase:', error);
      showMessage('error', 'Failed to initialize database connection');
    }

    // DOM elements
    const transactionForm = document.getElementById('transactionForm');
    const editTransactionForm = document.getElementById('editTransactionForm');
    const saveTransactionBtn = document.getElementById('saveTransactionBtn');
    const updateTransactionBtn = document.getElementById('updateTransactionBtn');
    const deleteTransactionBtn = document.getElementById('deleteTransactionBtn');
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const dateFilter = document.getElementById('dateFilter');
    const prevPageBtn = document.getElementById('prevPageBtn');
    const nextPageBtn = document.getElementById('nextPageBtn');
    const pageInfo = document.getElementById('pageInfo');

    // Pagination variables
    let currentPage = 1;
    const transactionsPerPage = 10;
    let totalTransactions = 0;
    let allTransactions = [];

    // Cache DOM elements
    const cache = {
      allTable: document.getElementById('allTransactionsTable'),
      creditsTable: document.getElementById('creditsTable'),
      debitsTable: document.getElementById('debitsTable'),
      allNoTransactions: document.getElementById('allNoTransactions'),
      creditsNoTransactions: document.getElementById('creditsNoTransactions'),
      debitsNoTransactions: document.getElementById('debitsNoTransactions'),
      availableBalance: document.getElementById('availableBalance'),
      totalCredits: document.getElementById('totalCredits'),
      totalDebits: document.getElementById('totalDebits')
    };

    // Load transactions when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Set up event listeners first
      setupEventListeners();
      
      // Then load data
      loadSummary();
      loadTransactions();
      
      // Set today's date as default in date filter
      dateFilter.valueAsDate = new Date();
    });

    // Set up all event listeners
    function setupEventListeners() {
      // Handle user display and logout
      auth.onAuthStateChanged(user => {
        if (user) {
          const displayName = user.displayName || user.email || 'User';
          document.getElementById('usernameDisplay').textContent = displayName;
          
          if (user.photoURL) {
            const userIcon = document.querySelector('#userDropdown i');
            userIcon.classList.remove('fa-user-circle');
            userIcon.style.backgroundImage = `url(${user.photoURL})`;
            userIcon.style.backgroundSize = 'cover';
            userIcon.style.width = '1.25em';
            userIcon.style.height = '1.25em';
            userIcon.style.borderRadius = '50%';
            userIcon.style.display = 'inline-block';
          }
        }
      });
      
      document.getElementById('logoutBtn').addEventListener('click', function(e) {
        e.preventDefault();
        auth.signOut().then(() => {
          window.location.href = 'index.html';
        });
      });

      // Transaction form handling
      saveTransactionBtn.addEventListener('click', saveTransaction);
      updateTransactionBtn.addEventListener('click', updateTransaction);
      deleteTransactionBtn.addEventListener('click', deleteTransaction);

      // Search and filter
      searchInput.addEventListener('input', debounce(filterTransactions, 300));
      categoryFilter.addEventListener('change', filterTransactions);
      dateFilter.addEventListener('change', filterTransactions);

      // Pagination
      prevPageBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          displayTransactions(allTransactions);
        }
      });

      nextPageBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(totalTransactions / transactionsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          displayTransactions(allTransactions);
        }
      });
    }

    // Debounce function for search input
    function debounce(func, wait) {
      let timeout;
      return function() {
        const context = this, args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          func.apply(context, args);
        }, wait);
      };
    }

    // Load all transactions with pagination
    async function loadTransactions() {
      try {
        // First get total count for pagination
        const { count } = await supabase
          .from('transactions')
          .select('*', { count: 'exact', head: true });

        totalTransactions = count || 0;

        // Then fetch paginated data
        const { data: transactions, error } = await supabase
          .from('transactions')
          .select('*')
          .order('date', { ascending: false })
          .range((currentPage - 1) * transactionsPerPage, currentPage * transactionsPerPage - 1);

        if (error) throw error;

        allTransactions = transactions || [];
        displayTransactions(allTransactions);
        updatePaginationControls();
      } catch (error) {
        console.error('Error loading transactions:', error.message);
        showMessage('error', 'Failed to load transactions');
      }
    }

    // Update pagination controls
    function updatePaginationControls() {
      const totalPages = Math.ceil(totalTransactions / transactionsPerPage);
      
      pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
      prevPageBtn.disabled = currentPage <= 1;
      nextPageBtn.disabled = currentPage >= totalPages;
    }

    // Display transactions in tables with virtualization
    function displayTransactions(transactions) {
      if (!transactions || transactions.length === 0) {
        cache.allTable.innerHTML = '';
        cache.creditsTable.innerHTML = '';
        cache.debitsTable.innerHTML = '';
        
        cache.allNoTransactions.style.display = 'block';
        cache.creditsNoTransactions.style.display = 'block';
        cache.debitsNoTransactions.style.display = 'block';
        return;
      }

      // Clear existing rows
      cache.allTable.innerHTML = '';
      cache.creditsTable.innerHTML = '';
      cache.debitsTable.innerHTML = '';

      // Hide no transactions messages
      cache.allNoTransactions.style.display = 'none';
      cache.creditsNoTransactions.style.display = 'none';
      cache.debitsNoTransactions.style.display = 'none';

      // Process transactions in chunks for better performance
      const chunkSize = 50;
      for (let i = 0; i < transactions.length; i += chunkSize) {
        const chunk = transactions.slice(i, i + chunkSize);
        
        // Use requestIdleCallback to avoid blocking the main thread
        if (window.requestIdleCallback) {
          requestIdleCallback(() => {
            processTransactionChunk(chunk);
          }, { timeout: 1000 });
        } else {
          processTransactionChunk(chunk);
        }
      }
    }

    // Process a chunk of transactions
    function processTransactionChunk(chunk) {
      const documentFragmentAll = document.createDocumentFragment();
      const documentFragmentCredits = document.createDocumentFragment();
      const documentFragmentDebits = document.createDocumentFragment();

      chunk.forEach(transaction => {
        const row = createTransactionRow(transaction);
        documentFragmentAll.appendChild(row.cloneNode(true));

        if (transaction.type === 'credit') {
          documentFragmentCredits.appendChild(row.cloneNode(true));
        } else {
          documentFragmentDebits.appendChild(row.cloneNode(true));
        }
      });

      cache.allTable.appendChild(documentFragmentAll);
      cache.creditsTable.appendChild(documentFragmentCredits);
      cache.debitsTable.appendChild(documentFragmentDebits);
    }

    // Create a transaction row for the table
    function createTransactionRow(transaction) {
      const row = document.createElement('tr');
      
      // Format date
      const date = new Date(transaction.date);
      const formattedDate = date.toLocaleDateString('en-IN', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });

      // Format amount with caching
      const formattedAmount = formatCurrency(transaction.amount);

      // Create cells
      row.innerHTML = `
        <td data-label="Date">${formattedDate}</td>
        ${transaction.type === 'all' ? <td data-label="Type"><span class="badge ${transaction.type === 'credit' ? 'badge-credit' : 'badge-debit'}">${transaction.type}</span></td> : ''}
        <td data-label="Description">${escapeHtml(transaction.description)}</td>
        <td data-label="Category">${formatCategory(transaction.category)}</td>
        <td data-label="Amount" class="amount-cell ${transaction.type === 'credit' ? 'credit' : 'debit'}">${formattedAmount}</td>
        <td data-label="Reference">${escapeHtml(transaction.reference) || '-'}</td>
        <td data-label="Actions" class="action-btns">
          <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${transaction.id}">
            <i class="fas fa-edit"></i>
          </button>
        </td>
      `;

      // Add edit event listener
      row.querySelector('.edit-btn').addEventListener('click', () => openEditModal(transaction.id));

      return row;
    }

    // Simple HTML escaping
    function escapeHtml(unsafe) {
      if (!unsafe) return unsafe;
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Format currency with caching
    const currencyFormatter = new Intl.NumberFormat('en-IN', {
      style: 'currency',
      currency: 'INR'
    });

    function formatCurrency(amount) {
      return currencyFormatter.format(amount);
    }

    // Format category for display
    function formatCategory(category) {
      const categories = {
        'customer_payment': 'Customer Payment',
        'supplier_payment': 'Supplier Payment',
        'expense': 'Expense',
        'investment': 'Investment',
        'other': 'Other'
      };
      return categories[category] || category;
    }

    // Load summary data with a single query
    async function loadSummary() {
      try {
        // Use a single query with conditional aggregation for better performance
        const { data, error } = await supabase
          .from('transactions')
          .select(`
            type,
            amount
          `);

        if (error) throw error;

        let totalCredits = 0;
        let totalDebits = 0;

        data.forEach(transaction => {
          if (transaction.type === 'credit') {
            totalCredits += transaction.amount;
          } else {
            totalDebits += transaction.amount;
          }
        });

        const balance = totalCredits - totalDebits;

        // Update UI with formatted numbers
        cache.availableBalance.textContent = formatCurrency(balance);
        cache.totalCredits.textContent = formatCurrency(totalCredits);
        cache.totalDebits.textContent = formatCurrency(totalDebits);
      } catch (error) {
        console.error('Error loading summary:', error.message);
        cache.availableBalance.textContent = 'Error';
        cache.totalCredits.textContent = 'Error';
        cache.totalDebits.textContent = 'Error';
      }
    }

    // Save new transaction with loading state
    async function saveTransaction() {
      const type = document.getElementById('transactionType').value;
      const amount = parseFloat(document.getElementById('transactionAmount').value);
      const description = document.getElementById('transactionDescription').value;
      const category = document.getElementById('transactionCategory').value;
      const reference = document.getElementById('transactionReference').value;

      // Validate form
      if (!type || !amount || !description || !category) {
        showMessage('error', 'Please fill all required fields', 'transactionMessage');
        return;
      }

      // Show loading state
      const saveBtnText = document.getElementById('saveBtnText');
      const saveBtnSpinner = document.getElementById('saveBtnSpinner');
      saveBtnText.textContent = 'Saving...';
      saveBtnSpinner.style.display = 'inline-block';
      saveTransactionBtn.disabled = true;

      try {
        const { data, error } = await supabase
          .from('transactions')
          .insert([
            { 
              type, 
              amount, 
              description, 
              category, 
              reference,
              date: new Date().toISOString()
            }
          ]);

        if (error) throw error;

        // Reset form and close modal
        transactionForm.reset();
        bootstrap.Modal.getInstance(document.getElementById('addTransactionModal')).hide();
        
        // Reload data
        loadTransactions();
        loadSummary();
        
        showMessage('success', 'Transaction added successfully');
      } catch (error) {
        console.error('Error saving transaction:', error.message);
        showMessage('error', 'Failed to add transaction', 'transactionMessage');
      } finally {
        // Reset button state
        saveBtnText.textContent = 'Save Transaction';
        saveBtnSpinner.style.display = 'none';
        saveTransactionBtn.disabled = false;
      }
    }

    // Open edit modal with transaction data
    async function openEditModal(transactionId) {
      try {
        const { data: transaction, error } = await supabase
          .from('transactions')
          .select('*')
          .eq('id', transactionId)
          .single();

        if (error) throw error;

        // Populate form
        document.getElementById('editTransactionId').value = transaction.id;
        document.getElementById('editTransactionType').value = transaction.type;
        document.getElementById('editTransactionAmount').value = transaction.amount;
        document.getElementById('editTransactionDescription').value = transaction.description;
        document.getElementById('editTransactionCategory').value = transaction.category;
        document.getElementById('editTransactionReference').value = transaction.reference || '';

        // Show modal
        const editModal = new bootstrap.Modal(document.getElementById('editTransactionModal'));
        editModal.show();
      } catch (error) {
        console.error('Error loading transaction:', error.message);
        showMessage('error', 'Failed to load transaction details');
      }
    }

    // Update transaction with loading state
    async function updateTransaction() {
      const id = document.getElementById('editTransactionId').value;
      const type = document.getElementById('editTransactionType').value;
      const amount = parseFloat(document.getElementById('editTransactionAmount').value);
      const description = document.getElementById('editTransactionDescription').value;
      const category = document.getElementById('editTransactionCategory').value;
      const reference = document.getElementById('editTransactionReference').value;

      // Validate form
      if (!type || !amount || !description || !category) {
        showMessage('error', 'Please fill all required fields', 'editTransactionMessage');
        return;
      }

      // Show loading state
      const updateBtnText = document.getElementById('updateBtnText');
      const updateBtnSpinner = document.getElementById('updateBtnSpinner');
      updateBtnText.textContent = 'Updating...';
      updateBtnSpinner.style.display = 'inline-block';
      updateTransactionBtn.disabled = true;

      try {
        const { data, error } = await supabase
          .from('transactions')
          .update({ type, amount, description, category, reference })
          .eq('id', id);

        if (error) throw error;

        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('editTransactionModal')).hide();
        
        // Reload data
        loadTransactions();
        loadSummary();
        
        showMessage('success', 'Transaction updated successfully');
      } catch (error) {
        console.error('Error updating transaction:', error.message);
        showMessage('error', 'Failed to update transaction', 'editTransactionMessage');
      } finally {
        // Reset button state
        updateBtnText.textContent = 'Update Transaction';
        updateBtnSpinner.style.display = 'none';
        updateTransactionBtn.disabled = false;
      }
    }

    // Delete transaction with confirmation and loading state
    async function deleteTransaction() {
      const id = document.getElementById('editTransactionId').value;
      
      if (!confirm('Are you sure you want to delete this transaction? This action cannot be undone.')) {
        return;
      }

      // Show loading state
      const deleteBtnText = document.getElementById('deleteBtnText');
      const deleteBtnSpinner = document.getElementById('deleteBtnSpinner');
      deleteBtnText.textContent = 'Deleting...';
      deleteBtnSpinner.style.display = 'inline-block';
      deleteTransactionBtn.disabled = true;

      try {
        const { data, error } = await supabase
          .from('transactions')
          .delete()
          .eq('id', id);

        if (error) throw error;

        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('editTransactionModal')).hide();
        
        // Reload data
        loadTransactions();
        loadSummary();
        
        showMessage('success', 'Transaction deleted successfully');
      } catch (error) {
        console.error('Error deleting transaction:', error.message);
        showMessage('error', 'Failed to delete transaction', 'editTransactionMessage');
      } finally {
        // Reset button state
        deleteBtnText.textContent = 'Delete';
        deleteBtnSpinner.style.display = 'none';
        deleteTransactionBtn.disabled = false;
      }
    }

    // Search and filter functionality with debouncing
    async function filterTransactions() {
      const searchTerm = searchInput.value.toLowerCase();
      const category = categoryFilter.value;
      const date = dateFilter.value;

      let query = supabase
        .from('transactions')
        .select('*', { count: 'exact' })
        .order('date', { ascending: false });

      if (searchTerm) {
    query = query.or(
        description.ilike("%${searchTerm}%"),
        reference.ilike("%${searchTerm}%")
    )
}

      if (category) {
        query = query.eq('category', category);
      }

      if (date) {
        const startDate = new Date(date);
        const endDate = new Date(date);
        endDate.setDate(endDate.getDate() + 1);
        
        query = query.gte('date', startDate.toISOString())
                     .lt('date', endDate.toISOString());
      }

      // Reset to first page when filtering
      currentPage = 1;
      
      try {
        const { data: transactions, count, error } = await query
          .range((currentPage - 1) * transactionsPerPage, currentPage * transactionsPerPage - 1);

        if (error) throw error;

        totalTransactions = count || 0;
        allTransactions = transactions || [];
        displayTransactions(allTransactions);
        updatePaginationControls();
      } catch (error) {
        console.error('Error filtering transactions:', error.message);
      }
    }

    // Show message to user
    function showMessage(type, text, elementId = 'message') {
      const messageElement = document.getElementById(elementId);
      messageElement.textContent = text;
      messageElement.className = `${type}-message`;
      messageElement.style.display = 'block';

      // Hide after 5 seconds
      setTimeout(() => {
        messageElement.style.display = 'none';
      }, 5000);
    }
  </script>
</body>
</html>